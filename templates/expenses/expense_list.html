{% extends 'base.html' %}

{% block title %}Expense Transactions{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header with Title and Action Buttons -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">Expense Transactions</h1>
        <div class="flex space-x-3">
            <button id="add-expense-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-200 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                <span>Add Expense</span>
            </button>
            <button id="toggle-filter" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300 transition duration-200">
                Filter
            </button>
        </div>
    </div>

    <!-- Date Range Filter Form (Hidden by Default) -->
    <div id="filter-form" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Filter by Date Range</h2>
        <form method="get" class="flex flex-wrap items-end gap-4">
            <div>
                <label for="start_date" class="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                <input type="date" id="start_date" name="start_date" value="{{ start_date|date:'Y-m-d' }}"
                    class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>
            <div>
                <label for="end_date" class="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                <input type="date" id="end_date" name="end_date" value="{{ end_date|date:'Y-m-d' }}"
                    class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>
            <div class="flex space-x-2">
                <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-200">
                    Apply Filter
                </button>
                <a href="{% url 'expense_list' %}" class="bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 transition duration-200">
                    Clear Filter
                </a>
            </div>
        </form>
    </div>

    <!-- Main Content Card -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="p-6">
            <!-- Total Expenses Summary -->
            <div class="mb-4">
                <p class="text-xl font-semibold text-gray-800">Total Expenses: <span class="text-red-600">₹{{ total|floatformat:2 }}</span></p>
                {% if start_date and end_date %}
                <p class="text-sm text-gray-600 mt-1">Showing expenses from {{ start_date|date:"F j, Y" }} to {{ end_date|date:"F j, Y" }}</p>
                {% endif %}
            </div>
            
            <!-- Expenses Table -->
            {% if expenses %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Date
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Category
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Amount
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for expense in expenses %}
                        <tr data-id="{{ expense.id }}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ expense.date }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ expense.category.name }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-red-600">
                                ₹{{ expense.amount }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex gap-4">
                                    <button class="edit-expense-btn text-blue-600 hover:text-blue-800" data-id="{{ expense.id }}" title="Edit">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                        </svg>
                                    </button>
                                    <button class="delete-expense-btn text-red-600 hover:text-red-800" data-id="{{ expense.id }}" title="Delete">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-gray-500 text-center py-8">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <p class="text-lg">No expense transactions found</p>
                <p class="text-sm mt-2">Click "Add Expense" to create your first expense record</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal container for dynamic content -->
<div id="modal-container" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full p-6 m-4">
        <div class="flex justify-between items-center mb-4">
            <h2 id="modal-title" class="text-xl font-bold text-gray-800">Modal Title</h2>
            <button id="close-modal" class="text-gray-500 hover:text-gray-700 focus:outline-none">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div id="modal-content">
            <!-- Dynamic content will be loaded here -->
        </div>
    </div>
</div>

<!-- Notification toast -->
<div id="notification-toast" class="fixed top-4 right-4 z-50 hidden bg-white rounded-lg shadow-lg p-4 max-w-md transform transition-transform duration-300">
    <div class="flex items-center">
        <div id="notification-icon" class="flex-shrink-0 mr-3">
            <!-- Icon will be placed here -->
        </div>
        <div class="mr-2">
            <p id="notification-message" class="text-sm font-medium text-gray-900"></p>
        </div>
        <button id="close-notification" class="ml-auto bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500 focus:outline-none">
            <span class="sr-only">Close</span>
            <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // DOM Elements
    const toggleButton = document.getElementById('toggle-filter');
    const filterForm = document.getElementById('filter-form');
    const modalContainer = document.getElementById('modal-container');
    const modalTitle = document.getElementById('modal-title');
    const modalContent = document.getElementById('modal-content');
    const closeModalButton = document.getElementById('close-modal');
    const addExpenseButton = document.getElementById('add-expense-btn');
    const editExpenseButtons = document.querySelectorAll('.edit-expense-btn');
    const deleteExpenseButtons = document.querySelectorAll('.delete-expense-btn');
    const notificationToast = document.getElementById('notification-toast');
    const notificationMessage = document.getElementById('notification-message');
    const notificationIcon = document.getElementById('notification-icon');
    const closeNotificationButton = document.getElementById('close-notification');
    
    // Check if start_date and end_date parameters exist in the URL
    const urlParams = new URLSearchParams(window.location.search);
    const hasStartDate = urlParams.has('start_date');
    const hasEndDate = urlParams.has('end_date');
    
    // Show filter form if there are active filters
    if (hasStartDate && hasEndDate) {
        filterForm.classList.remove('hidden');
    }

    // Toggle filter form visibility when button is clicked
    if (toggleButton) {
        toggleButton.addEventListener('click', function() {
            filterForm.classList.toggle('hidden');
        });
    }
    
    // Close modal when close button is clicked
    if (closeModalButton) {
        closeModalButton.addEventListener('click', function() {
            modalContainer.classList.add('hidden');
        });
    }
    
    // Close modal when clicking outside of it
    if (modalContainer) {
        modalContainer.addEventListener('click', function(e) {
            if (e.target === modalContainer) {
                modalContainer.classList.add('hidden');
            }
        });
    }
    
    // Close notification when button is clicked
    if (closeNotificationButton) {
        closeNotificationButton.addEventListener('click', function() {
            notificationToast.classList.add('hidden');
        });
    }
    
    // Function to show notification
    function showNotification(message, type = 'success') {
        if (!notificationMessage || !notificationIcon || !notificationToast) return;
        
        notificationMessage.textContent = message;
        
        // Set icon based on type
        let iconSvg = '';
        if (type === 'success') {
            iconSvg = '<svg class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>';
        } else if (type === 'error') {
            iconSvg = '<svg class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>';
        } else if (type === 'warning') {
            iconSvg = '<svg class="h-6 w-6 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>';
        }
        
        notificationIcon.innerHTML = iconSvg;
        notificationToast.classList.remove('hidden');
        
        // Add animation
        notificationToast.classList.add('translate-y-0');
        notificationToast.classList.remove('translate-y-[-100%]');
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            notificationToast.classList.add('hidden');
        }, 5000);
    }
    
    // Function to open modal with content
    function openModal(title, url, formSubmitCallback) {
        if (!modalTitle || !modalContent || !modalContainer) return;
        
        modalTitle.textContent = title;
        modalContent.innerHTML = '<div class="flex justify-center p-8"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div></div>';
        modalContainer.classList.remove('hidden');
        
        // Fetch content from URL
        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            modalContent.innerHTML = html;
            
            // Find form in modal content
            const form = modalContent.querySelector('form');
            if (form && formSubmitCallback) {
                form.addEventListener('submit', formSubmitCallback);
            }
            
            // Handle cancel buttons in the loaded content
            initializeModalButtons();
        })
        .catch(error => {
            console.error('Error loading content:', error);
            modalContent.innerHTML = '<p class="text-red-600 p-4">Error loading content. Please try again.</p>';
        });
    }
    
    // Helper function to initialize buttons in modal content
    function initializeModalButtons() {
        // Handle cancel buttons in the loaded form
        const cancelFormButton = modalContent.querySelector('#cancel-form');
        if (cancelFormButton) {
            cancelFormButton.addEventListener('click', function(e) {
                e.preventDefault();
                modalContainer.classList.add('hidden');
            });
        }
        
        // Handle cancel button in delete confirmation
        const cancelDeleteButton = modalContent.querySelector('#cancel-delete');
        if (cancelDeleteButton) {
            cancelDeleteButton.addEventListener('click', function(e) {
                e.preventDefault();
                modalContainer.classList.add('hidden');
            });
        }
        
        // Handle cancel button in budget alert
        const cancelExpenseButton = modalContent.querySelector('#cancel-expense');
        if (cancelExpenseButton) {
            cancelExpenseButton.addEventListener('click', function(e) {
                e.preventDefault();
                modalContainer.classList.add('hidden');
            });
        }
    }
    
    // Add Expense button click handler
    if (addExpenseButton) {
        addExpenseButton.addEventListener('click', function() {
            openModal('Add Expense', '{% url "add_expense" %}', handleExpenseFormSubmit);
        });
    }
    
    // Edit Expense buttons click handlers
    if (editExpenseButtons) {
        editExpenseButtons.forEach(button => {
            button.addEventListener('click', function() {
                const expenseId = this.getAttribute('data-id');
                openModal('Edit Expense', `/expenses/edit/${expenseId}/`, handleExpenseFormSubmit);
            });
        });
    }
    
    // Delete Expense buttons click handlers
    if (deleteExpenseButtons) {
        deleteExpenseButtons.forEach(button => {
            button.addEventListener('click', function() {
                const expenseId = this.getAttribute('data-id');
                openModal('Delete Expense', `/expenses/delete/${expenseId}/`, handleDeleteFormSubmit);
            });
        });
    }
    
    // Handle expense form submission
    function handleExpenseFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Success - close modal and refresh page
                modalContainer.classList.add('hidden');
                showNotification(data.message || 'Expense saved successfully!');
                
                // Reload page after a short delay
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else if (data.budget_alert && data.budget_alert.severity === 'exceeded') {
                // Handle budget alert case
                modalContent.innerHTML = data.html || 'Budget limit exceeded. Please confirm or cancel.';
                
                // Re-initialize buttons in the newly loaded content
                initializeModalButtons();
            } else {
                // Handle other errors
                const errorMessage = data.message || 'An error occurred. Please check the form.';
                showNotification(errorMessage, 'error');
            }
        })
        .catch(error => {
            console.error('Error submitting form:', error);
            showNotification('An error occurred. Please try again.', 'error');
        });
    }
    
    // Handle delete form submission
    function handleDeleteFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
       
        fetch(form.action, {
            method: 'POST',
            body: new FormData(form),
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Success - close modal and show notification
                modalContainer.classList.add('hidden');
                showNotification(data.message || 'Expense deleted successfully!');
                
                // Remove the deleted expense row from the table if present
                if (data.expense_id) {
                    const expenseRow = document.querySelector(`tr[data-id="${data.expense_id}"]`);
                    if (expenseRow) {
                        expenseRow.remove();
                    }
                    
                    // If we removed the last row, reload to show empty state
                    const remainingRows = document.querySelectorAll('tbody tr');
                    if (remainingRows.length === 0) {
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                } else {
                    // If we don't have the ID, just reload the page
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                }
            } else {
                // Handle errors
                const errorMessage = data.message || 'An error occurred. Please try again.';
                showNotification(errorMessage, 'error');
            }
        })
        .catch(error => {
            console.error('Error submitting form:', error);
            showNotification('An error occurred. Please try again.', 'error');
        });
    }
    
    // Budget override confirmation function for global access
    window.confirmBudgetOverride = function() {
        // Find the form and set the override value
        const form = modalContent.querySelector('form');
        if (form) {
            const budgetOverrideField = form.querySelector('#budget_override');
            if (budgetOverrideField) {
                budgetOverrideField.value = 'true';
            }
            
            // Submit the form again
            const formData = new FormData(form);
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    modalContainer.classList.add('hidden');
                    showNotification(data.message || 'Expense saved despite exceeding budget!', 'warning');
                    
                    // Reload page after a short delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showNotification('Error saving expense.', 'error');
                }
            })
            .catch(error => {
                console.error('Error submitting form:', error);
                showNotification('An error occurred. Please try again.', 'error');
            });
        }
    };
});
</script>
{% endblock %}